<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>证据升级校验 · {{ cert_id }}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="data:,">
  <style>
    body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei";margin:24px;color:#222;background:#fafafa}
    .card{max-width:880px;margin:auto;background:#fff;border:1px solid #eee;border-radius:12px;padding:20px 24px;box-shadow:0 4px 16px rgba(0,0,0,.04);margin-bottom:16px}
    h1{margin:0 0 8px;font-size:26px}
    h3{margin:0 0 8px;font-size:18px}
    .muted{color:#666}
    code{background:#f6f6f6;padding:2px 6px;border-radius:6px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;line-height:18px;border:1px solid transparent;vertical-align:middle}
    .badge-tsa{background:#e6f0ff;color:#1e40af;border-color:#bfdbfe}
    .badge-chain{background:#e8fff0;color:#166534;border-color:#bbf7d0}
    .status-success{color:#166534;font-weight:600}
    .status-failed{color:#991b1b;font-weight:600}
    .status-pending{color:#92400e;font-weight:600}
    .btn.btn-xs{ padding:2px 6px; font-size:12px; border-radius:6px; }
    .highlight-copy{ background:#fffbe6 !important; transition: background .6s ease; }
    #pv-body td:nth-child(4){ font-family:ui-monospace, Menlo, Consolas, monospace; }
    #pv-body td{ white-space:nowrap; vertical-align:middle; }
    #btn-export[disabled]{ cursor:not-allowed; }
  </style>
</head>
<body>

  <div class="card">
    <h1>Verify Upgrade</h1>
    <p class="muted">CERT ID：<code>{{ cert_id }}</code></p>
  </div>

  <div class="card">
    <h3>最近回执</h3>
    {% set last_status = tsa_last_status|default('', true) %}
    {% set last_txid   = tsa_last_txid|default('', true) %}
    {% set last_provider = (history[0]['provider'] if (history is defined and history and history|length>0 and history[0] is mapping and 'provider' in history[0]) else
                            (history[0].provider if (history is defined and history and history|length>0 and history[0] is not mapping and history[0].provider is defined) else None)) %}
    {% if last_status %}
      <p>来源：
        {% if last_provider %}
          <span class="badge {{ 'badge-tsa' if last_provider=='tsa' else 'badge-chain' }}">{{ last_provider }}</span>
        {% else %}<span class="muted">未知</span>{% endif %}
      </p>
      <p>状态：
        {% set st = 'success' if last_status in ['ok','success']
         else 'failed' if last_status in ['error','failed']
         else 'pending' %}
        <span class="status-{{ st }}">{{ last_status }}</span>
      </p>
      <p>TX：
{% if last_txid %}
  <code>{{ last_txid|e }}</code>
  <button class="btn btn-xs" data-copy-txid="{{ last_txid }}" aria-label="复制 txid">复制</button>
{% else %}
  <span class="muted">无</span>
{% endif %}
</p>

    {% else %}
      <p class="muted">暂无回执。请先调用 TSA/Chain 回执接口。</p>
    {% endif %}
  </div>

  <div class="card">
    <h3>回执历史（近 5 条）</h3>
    {% if history is defined and history and history|length>0 %}
      <ul>
        {% for r in history %}
          {% set provider = r.provider if r is not mapping else r.get('provider') %}
          {% set status   = r.status   if r is not mapping else r.get('status') %}
          {% set txid     = r.txid     if r is not mapping else r.get('txid') %}
          {% set created  = r.created_at if r is not mapping else r.get('created_at') %}
          <li>
            [{% if created %}{{ created }}{% else %}--{% endif %}]
            <span class="badge {{ 'badge-tsa' if provider=='tsa' else 'badge-chain' }}">{{ provider|default('unknown') }}</span>
            {% set map = {'ok':'success','success':'success','failed':'failed','error':'failed','pending':'pending'} %}
            · <span class="status-{{ map.get((status or '')|lower, 'pending') }}">{{ status|default('pending') }}</span>
    {% if txid %}
        · TX: <code>{{ txid|e }}</code>
        <button class="btn btn-xs" data-copy-txid="{{ txid }}" aria-label="复制 txid">复制</button>
{% endif %}

          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="muted">暂无历史记录。</p>
    {% endif %}
  </div>

  <div class="card">
    <h3>证据信息（示例字段）</h3>
    {% set ev = evidence if evidence is defined else {} %}
    <ul>
      <li>文件：<code>{{ (ev.file_path if ev is not mapping else ev.get('file_path'))|default('--') }}</code></li>
      <li>SHA-256：<code>{{ (ev.sha256   if ev is not mapping else ev.get('sha256'))|default('--') }}</code></li>
      <li>C2PA Claim：<code>{{ (ev.c2pa_claim if ev is not mapping else ev.get('c2pa_claim'))|default('--') }}</code></li>
      <li>TSA URL：<code>{{ (ev.tsa_url if ev is not mapping else ev.get('tsa_url'))|default('--') }}</code></li>
      <li>Sepolia Tx：<code>{{ (ev.sepolia_txhash if ev is not mapping else ev.get('sepolia_txhash'))|default('--') }}</code></li>
    </ul>
    <p class="muted">以上为示例位，可与实际入库字段对齐替换。</p>
  </div>
<!-- 快捷操作 + 健康提示条 -->
<div id="quick-actions" style="margin:10px 0;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
  <button id="btn-refresh" style="padding:6px 10px;border:1px solid #d1d5db;background:#f9fafb;border-radius:8px;cursor:pointer">刷新历史</button>
  <button id="btn-clear"   style="padding:6px 10px;border:1px solid #d1d5db;background:#f9fafb;border-radius:8px;cursor:pointer">清空历史</button>
  <button id="btn-preview" style="padding:6px 10px;border:1px solid #d1d5db;background:#fff;border-radius:8px;cursor:pointer">预览</button>
  <button id="btn-export"  style="padding:6px 10px;border:1px solid #d1d5db;background:#f0f9ff;border-radius:8px;cursor:pointer">导出 CSV</button>
  <span id="export-hint"  style="font-size:12px;color:#6b7280;">（预计：-- 条）</span>

  <!-- 在这行后面插入“清空所有”按钮 -->
  <button id="btn-clear-all"
          style="display:none;padding:6px 10px;border:1px solid #ef4444;background:#fff5f5;border-radius:8px;cursor:pointer;color:#b91c1c"
          title="仅本机显示：清空所有证书（内存+DB）">清空所有（All）</button>

  <!-- 下面是原有的输入/下拉/导出按钮 -->
  <input id="hist-q" placeholder="关键词（可含 tx 片段）" style="padding:6px 8px;border:1px solid #d1d5db;border-radius:8px;min-width:180px" />
  <label style="font-size:12px;color:#666">Provider</label>
  <select id="sel-provider" style="padding:6px 8px;border:1px solid #d1d5db;border-radius:8px">
    <option value="">All</option><option value="tsa">tsa</option><option value="chain">chain</option>
  </select>
  <label style="font-size:12px;color:#666">Status</label>
  <select id="sel-status" style="padding:6px 8px;border:1px solid #d1d5db;border-radius:8px">
    <option value="">All</option><option value="ok">ok</option><option value="pending">pending</option><option value="failed">failed</option>
  </select>
<button id="btn-seed" class="btn">写入示例数据</button>
<span id="quick-msg" style="color:#6b7280;font-size:12px;margin-left:6px"></span>
</div>

<div id="health-tip" style="margin-top:10px;padding:8px 12px;border:1px solid #eee;border-radius:8px;font-size:13px;background:#fafafa">正在读取健康信息…</div>

<script>
(()=> {
  'use strict';

  const cert = "{{ cert_id|default('') }}";
  const msg  = s => { const el = document.getElementById('quick-msg'); if (el) el.textContent = s || ''; };

  // ===== 工具函数区 =====
  function escHtml(s){
    return String(s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function flashNode(el){
    if(!el) return;
    el.classList.add('highlight-copy');
    setTimeout(()=> el.classList.remove('highlight-copy'), 700);
  }

  function debounce(fn, ms = 200){
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), ms);
    };
  }  // ← 结束 debounce

  let __countReqId = 0;  // 计数请求序号（用于丢弃过期响应）
  // ===== 工具函数区结束 =====

  // —— 筛选项本地记忆（按 cert 作用域）——
  const _memKey = (name) => `vu:${cert}:filter:${name}`;

  function loadFilters() {
    try {
      const q = localStorage.getItem(_memKey('q')) ?? '';
      const provider = localStorage.getItem(_memKey('provider')) ?? '';
      const status   = localStorage.getItem(_memKey('status')) ?? '';
      const qEl   = document.getElementById('hist-q');
      const pEl   = document.getElementById('sel-provider');
      const sEl   = document.getElementById('sel-status');
      if (qEl) qEl.value = q;
      if (pEl) pEl.value = provider;
      if (sEl) sEl.value = status;
    } catch (e) {}
  }

  function saveFilters() {
    try {
      const qEl   = document.getElementById('hist-q');
      const pEl   = document.getElementById('sel-provider');
      const sEl   = document.getElementById('sel-status');
      if (qEl) localStorage.setItem(_memKey('q'), qEl.value || '');
      if (pEl) localStorage.setItem(_memKey('provider'), (pEl.value || ''));
      if (sEl) localStorage.setItem(_memKey('status'),   (sEl.value || ''));
    } catch (e) {}
  }

  // 刷新按钮
  const btnRefresh = document.getElementById('btn-refresh');
  if (btnRefresh) btnRefresh.onclick = () =>
    location.replace(location.pathname + '?t=' + Date.now());

  // 清空（单证书）
  const btnClear = document.getElementById('btn-clear');
  if (btnClear) btnClear.onclick = () => {
    fetch(`/api/receipts/clear?cert_id=${encodeURIComponent(cert)}`, { method: 'POST' })
      .then(r => r.json())
      .then(async d => {
        msg(`已清空 ${d.cleared || 0} 条`);
        const h = await fetch('/health?' + new URLSearchParams({ cert_id: cert })).then(r => r.json());
        renderHealth(h);
        updateExportHint();
        setTimeout(() => location.replace(location.pathname + '?t=' + Date.now()), 200);
      })
      .catch(() => msg('清空失败，请重试'));
  };

  // 一键写入示例数据
  const seedBtn = document.getElementById('btn-seed');
  if (seedBtn) {
    let busy = false;
    seedBtn.onclick = async () => {
      if (busy) return; busy = true; seedBtn.disabled = true;
      try {
        await Promise.all([
          fetch(`/api/tsa/mock?cert_id=${encodeURIComponent(cert)}`),
          fetch(`/api/chain/mock?cert_id=${encodeURIComponent(cert)}`)
        ]);
        msg('已写入示例数据 2 条');
        updateExportHint();
        setTimeout(() => location.replace(location.pathname + '?t=' + Date.now()), 250);
      } catch (e) {
        msg('写入失败，请重试');
      } finally {
        busy = false; seedBtn.disabled = false;
      }
    };
  }

  // 清空所有（仅本机显示 + 二次确认）
  const btnClearAll = document.getElementById('btn-clear-all');
  if (btnClearAll) {
    const isLocal = (location.hostname === '127.0.0.1' || location.hostname === 'localhost');
    if (isLocal) btnClearAll.style.display = 'inline-block';

    btnClearAll.onclick = async () => {
      if (!isLocal) return;
      if (!confirm('⚠️ 将清空【所有证书】的历史记录（内存 + DB）。确定继续？')) return;
      const text = prompt('第二步确认：请输入 DELETE');
      if ((text || '').trim().toUpperCase() !== 'DELETE') { msg('已取消'); return; }

      try {
        btnClearAll.disabled = true;
        const res = await fetch('/api/receipts/clear', { method: 'POST' }); // 不带 cert_id => 全清
        const d = await res.json();
        msg(`已清空所有：${d.cleared || 0} 条`);
        const h = await fetch('/health?' + new URLSearchParams({ cert_id: cert })).then(r=>r.json());
        renderHealth(h);
        updateExportHint();
        setTimeout(() => location.replace(location.pathname + '?t=' + Date.now()), 300);
      } catch (e) {
        msg('清空失败，请重试');
      } finally {
        btnClearAll.disabled = false;
      }
    };
  }

  // 健康提示条
  const hEl = document.getElementById('health-tip');
  function renderHealth(d){
    const ok = d.ok !== false;
    const cnt = d.db && typeof d.db.receipts_count !== 'undefined' ? d.db.receipts_count : '–';
    const sqlite = d.db && d.db.sqlite_exists ? '✅ DB 就绪' : '⚠️ DB';
    const tsa = d.config && d.config.tsa_endpoint ? d.config.tsa_endpoint : '（未配置或基础版）';
    hEl.innerHTML = `状态：${ok ? '✅ 正常' : '❌ 异常'}｜${sqlite}｜条目：<b>${cnt}</b>｜TSA：<code>${tsa}</code>`;
    hEl.style.background = ok ? '#f0fff4' : '#fff5f5';
    hEl.style.borderColor = ok ? '#b7f7c2' : '#ffb3b3';
  }

  const qs1 = new URLSearchParams({ cert_id: cert }).toString();
  fetch(`/health?${qs1}`).then(r => r.json()).then(renderHealth).catch(()=>{});
  setInterval(() => {
    fetch(`/health?${qs1}`).then(r => r.json()).then(renderHealth).catch(()=>{});
  }, 5000);

  // 导出 CSV
  const btnExport = document.getElementById('btn-export');
  if (btnExport) btnExport.onclick = () => {
    updateExportHint(); // 点击导出前先刷新提示
    const qEl   = document.getElementById('hist-q');
    const prov  = (document.getElementById('sel-provider')?.value || '').trim();
    const stat  = (document.getElementById('sel-status')?.value   || '').trim();

    const parts = [];
    if (prov) parts.push(`provider:${prov}`);
    if (stat) parts.push(`status:${stat}`);
    const free = qEl ? (qEl.value || '').trim() : '';
    if (free) parts.push(free);

    const qs = new URLSearchParams({ cert_id: cert });
    if (parts.length) qs.set('q', parts.join(' '));
    qs.set('t', Date.now().toString());
    window.open('/api/receipts/export?' + qs.toString(), '_blank');
  };

  // 构建查询
  function buildQueryParts(){
    const qEl = document.getElementById('hist-q');
    const prov = (document.getElementById('sel-provider')?.value || '').trim();
    const stat = (document.getElementById('sel-status')?.value || '').trim();
    const parts = [];
    if (prov) parts.push(`provider:${prov}`);
    if (stat) parts.push(`status:${stat}`);
    const free = qEl ? (qEl.value || '').trim() : '';
    if (free) parts.push(free);
    return parts;
  }

  // 精确计数（防抖 + 防并发）
  async function updateExportHint(){
    const hintEl = document.getElementById('export-hint');
    if (!hintEl) return;
    try {
      const reqId = ++__countReqId;
      const parts = buildQueryParts();
      const qs = new URLSearchParams({ cert_id: String(cert), t: Date.now().toString() });
      if (parts.length) qs.set('q', parts.join(' '));
      const d = await fetch('/api/receipts/count?' + qs).then(r => r.json());
      if (reqId !== __countReqId) return;  // 丢弃过期结果
      const n = (d && d.ok && typeof d.count === 'number') ? d.count : 0;
      hintEl.textContent = `（预计：${n} 条）`;
      const btn = document.getElementById('btn-export');
      if (btn){ btn.disabled = n <= 0; btn.style.opacity = n > 0 ? 1 : 0.5; }
    } catch (e) {
      const hintEl2 = document.getElementById('export-hint');
      if (hintEl2) hintEl2.textContent = '（预计：--）';
    }
  }

  // 监听筛选（200ms 防抖）
  const onFilterChange = debounce(() => { saveFilters(); updateExportHint(); }, 200);
  ['hist-q','sel-provider','sel-status'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('input',  onFilterChange);
    el.addEventListener('change', onFilterChange);
  });

  loadFilters();
  updateExportHint();

  // 预览弹窗
  function showPreviewDialog(data){
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:9999;';
    const card = document.createElement('div');
    card.style.cssText = 'background:#fff;border-radius:12px;max-width:900px;width:90vw;max-height:80vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.2);';
    card.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #eee;">
        <div style="font-weight:600">预览（前 ${data.limit} 条 / 共 ${data.total}）</div>
        <button id="pv-close" style="padding:4px 8px;border:1px solid #ddd;background:#f8f8f8;border-radius:8px;cursor:pointer">关闭</button>
      </div>
      <div style="padding:12px 16px;">
        <table style="width:100%;border-collapse:collapse;font-size:13px">
          <thead>
            <tr>
              <th style="text-align:left;border-bottom:1px solid #eee;padding:6px 8px;">cert_id</th>
              <th style="text-align:left;border-bottom:1px solid #eee;padding:6px 8px;">provider</th>
              <th style="text-align:left;border-bottom:1px solid #eee;padding:6px 8px;">status</th>
              <th style="text-align:left;border-bottom:1px solid #eee;padding:6px 8px;">txid</th>
              <th style="text-align:left;border-bottom:1px solid #eee;padding:6px 8px;">created_at</th>
            </tr>
          </thead>
          <tbody id="pv-body"></tbody>
        </table>
      </div>
    `;
    overlay.appendChild(card);
    document.body.appendChild(overlay);

    const tbody = card.querySelector('#pv-body');
    (data.rows || []).forEach(r => {
      const tr = document.createElement('tr');
      ['cert_id','provider','status','txid','created_at'].forEach(k=>{
        const td = document.createElement('td');
        td.style.cssText = 'border-bottom:1px solid #f3f3f3;padding:6px 8px;white-space:nowrap;';
        if (k === 'txid') {
          const tx = r[k] || '';
          const txEsc = escHtml(tx);
          td.innerHTML = tx
            ? `${txEsc} <button class="btn btn-xs" data-copy-txid="${tx}" title="复制 txid" aria-label="复制 txid">复制</button>`
            : '';
        } else {
          td.textContent = r[k] || '';
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    const close = () => overlay.remove();
    card.querySelector('#pv-close').onclick = close;
    overlay.onclick = (e) => { if (e.target === overlay) close(); };
  }

  // 预览按钮
  const btnPreview = document.getElementById('btn-preview');
  if (btnPreview) btnPreview.onclick = async () => {
    try{
      const parts = buildQueryParts();
      const qs = new URLSearchParams({ cert_id: String(cert), limit: '20', t: Date.now().toString() });
      if (parts.length) qs.set('q', parts.join(' '));
      const data = await fetch('/api/receipts/preview?' + qs).then(r=>r.json());
      if (!data || data.ok === false) { msg('预览失败'); return; }
      showPreviewDialog(data);
    } catch (e) { msg('预览失败'); }
  };

  // 复制文本 + 高亮
  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      if (typeof toast === 'function') { toast(`已复制：${text.slice(0,8)}...`); }
      else { msg(`已复制：${text.slice(0,8)}...`); }
    }catch(e){
      const ta=document.createElement('textarea');
      ta.value=text; document.body.appendChild(ta);
      ta.select(); document.execCommand('copy');
      document.body.removeChild(ta);
      msg(`已复制：${text.slice(0,8)}...`);
    }
  }

document.addEventListener('click', (ev)=>{
  const btn = ev.target.closest('[data-copy-txid]');
  if (!btn) return;

  const tx = btn.getAttribute('data-copy-txid') || '';
  if (tx) copyText(tx);

  // 防抖：已处于“已复制”状态就不重复改文案
  if (!btn.dataset.copied) {
    const oldText = btn.textContent;
    btn.dataset.copied = '1';
    btn.textContent = '已复制';
    btn.disabled = true;                 // 可选：短暂禁用，避免连点
    setTimeout(()=>{
      btn.textContent = oldText;
      btn.disabled = false;
      delete btn.dataset.copied;
    }, 500);
  }

  const row = btn.closest('tr') || btn.closest('li') || btn.parentElement;
  flashNode(row);
});
})(); 
</script>
</body>
</html>
