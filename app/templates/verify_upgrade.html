<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>证据升级校验 · {{ cert_id }}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="data:,">
  <style>
    body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei";margin:24px;color:#222;background:#fafafa}
    .card{max-width:880px;margin:auto;background:#fff;border:1px solid #eee;border-radius:12px;padding:20px 24px;box-shadow:0 4px 16px rgba(0,0,0,.04);margin-bottom:16px}
    h1{margin:0 0 8px;font-size:26px}
    h3{margin:0 0 8px;font-size:18px}
    .muted{color:#666}
    code{background:#f6f6f6;padding:2px 6px;border-radius:6px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;line-height:18px;border:1px solid transparent;vertical-align:middle}
    .badge-tsa{background:#e6f0ff;color:#1e40af;border-color:#bfdbfe}
    .badge-chain{background:#e8fff0;color:#166534;border-color:#bbf7d0}
    .status-success{color:#166534;font-weight:600}
    .status-failed{color:#991b1b;font-weight:600}
    .status-pending{color:#92400e;font-weight:600}
  </style>
</head>
<body>

  <div class="card">
    <h1>Verify Upgrade</h1>
    <p class="muted">CERT ID：<code>{{ cert_id }}</code></p>
  </div>

  <div class="card">
    <h3>最近回执</h3>
    {% set last_status = tsa_last_status|default('', true) %}
    {% set last_txid   = tsa_last_txid|default('', true) %}
    {% set last_provider = (history[0]['provider'] if (history is defined and history and history|length>0 and history[0] is mapping and 'provider' in history[0]) else
                            (history[0].provider if (history is defined and history and history|length>0 and history[0] is not mapping and history[0].provider is defined) else None)) %}
    {% if last_status %}
      <p>来源：
        {% if last_provider %}
          <span class="badge {{ 'badge-tsa' if last_provider=='tsa' else 'badge-chain' }}">{{ last_provider }}</span>
        {% else %}<span class="muted">未知</span>{% endif %}
      </p>
      <p>状态：
        {% set st = 'success' if last_status in ['ok','success']
         else 'failed' if last_status in ['error','failed']
         else 'pending' %}
        <span class="status-{{ st }}">{{ last_status }}</span>
      </p>
      <p>TX：{% if last_txid %}<code>{{ last_txid }}</code>{% else %}<span class="muted">无</span>{% endif %}</p>
    {% else %}
      <p class="muted">暂无回执。请先调用 TSA/Chain 回执接口。</p>
    {% endif %}
  </div>

  <div class="card">
    <h3>回执历史（近 5 条）</h3>
    {% if history is defined and history and history|length>0 %}
      <ul>
        {% for r in history %}
          {% set provider = r.provider if r is not mapping else r.get('provider') %}
          {% set status   = r.status   if r is not mapping else r.get('status') %}
          {% set txid     = r.txid     if r is not mapping else r.get('txid') %}
          {% set created  = r.created_at if r is not mapping else r.get('created_at') %}
          <li>
            [{% if created %}{{ created }}{% else %}--{% endif %}]
            <span class="badge {{ 'badge-tsa' if provider=='tsa' else 'badge-chain' }}">{{ provider|default('unknown') }}</span>
            {% set map = {'ok':'success','success':'success','failed':'failed','error':'failed','pending':'pending'} %}
            · <span class="status-{{ map.get((status or '')|lower, 'pending') }}">{{ status|default('pending') }}</span>
            {% if txid %} · TX: <code>{{ txid }}</code>{% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="muted">暂无历史记录。</p>
    {% endif %}
  </div>

  <div class="card">
    <h3>证据信息（示例字段）</h3>
    {% set ev = evidence if evidence is defined else {} %}
    <ul>
      <li>文件：<code>{{ (ev.file_path if ev is not mapping else ev.get('file_path'))|default('--') }}</code></li>
      <li>SHA-256：<code>{{ (ev.sha256   if ev is not mapping else ev.get('sha256'))|default('--') }}</code></li>
      <li>C2PA Claim：<code>{{ (ev.c2pa_claim if ev is not mapping else ev.get('c2pa_claim'))|default('--') }}</code></li>
      <li>TSA URL：<code>{{ (ev.tsa_url if ev is not mapping else ev.get('tsa_url'))|default('--') }}</code></li>
      <li>Sepolia Tx：<code>{{ (ev.sepolia_txhash if ev is not mapping else ev.get('sepolia_txhash'))|default('--') }}</code></li>
    </ul>
    <p class="muted">以上为示例位，可与实际入库字段对齐替换。</p>
  </div>
<!-- 快捷操作 + 健康提示条 -->
<div id="quick-actions" style="margin:10px 0;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
  <button id="btn-refresh" style="padding:6px 10px;border:1px solid #d1d5db;background:#f9fafb;border-radius:8px;cursor:pointer">刷新历史</button>
  <button id="btn-clear"   style="padding:6px 10px;border:1px solid #d1d5db;background:#f9fafb;border-radius:8px;cursor:pointer">清空历史</button>

  <!-- 关键词 -->
  <input id="hist-q" placeholder="关键词（可含 tx 片段）" style="padding:6px 8px;border:1px solid #d1d5db;border-radius:8px;min-width:180px" />

  <!-- Provider 下拉 -->
  <label style="font-size:12px;color:#666">Provider</label>
  <select id="sel-provider" style="padding:6px 8px;border:1px solid #d1d5db;border-radius:8px">
    <option value="">All</option>
    <option value="tsa">tsa</option>
    <option value="chain">chain</option>
  </select>

  <!-- Status 下拉 -->
  <label style="font-size:12px;color:#666">Status</label>
  <select id="sel-status" style="padding:6px 8px;border:1px solid #d1d5db;border-radius:8px">
    <option value="">All</option>
    <option value="ok">ok</option>
    <option value="pending">pending</option>
    <option value="failed">failed</option>
  </select>

  <button id="btn-export" style="padding:6px 10px;border:1px solid #d1d5db;background:#f0f9ff;border-radius:8px;cursor:pointer">导出 CSV</button>

  <button id="btn-seed" class="btn">写入示例数据</button>
  <span id="quick-msg" style="color:#6b7280;font-size:12px;margin-left:6px"></span>
</div>

<div id="health-tip" style="margin-top:10px;padding:8px 12px;border:1px solid #eee;border-radius:8px;font-size:13px;background:#fafafa">正在读取健康信息…</div>

<script>
(()=> {
  const cert = "{{ cert_id|default('') }}";
  const msg  = s => { const el = document.getElementById('quick-msg'); if (el) el.textContent = s || ''; };

  // 刷新
  const btnRefresh = document.getElementById('btn-refresh');
  if (btnRefresh) btnRefresh.onclick = () =>
    location.replace(location.pathname + '?t=' + Date.now());

  // 清空
  const btnClear = document.getElementById('btn-clear');
  if (btnClear) btnClear.onclick = () => {
    fetch(`/api/receipts/clear?cert_id=${encodeURIComponent(cert)}`, { method:'POST' })
      .then(r => r.json())
      .then(d => { msg(`已清空 ${d.cleared || 0} 条`); setTimeout(() => location.replace(location.pathname + '?t=' + Date.now()), 200); })
      .catch(() => msg('清空失败，请重试'));
  };

  // 一键写入示例数据：tsa ok + chain pending
  const seedBtn = document.getElementById('btn-seed');
  if (seedBtn) {
    let busy = false;
    seedBtn.onclick = async () => {
      if (busy) return; busy = true; seedBtn.disabled = true;
      try {
        await Promise.all([
          fetch(`/api/tsa/mock?cert_id=${encodeURIComponent(cert)}`),
          fetch(`/api/chain/mock?cert_id=${encodeURIComponent(cert)}`)
        ]);
        msg('已写入示例数据 2 条');
        setTimeout(() => location.replace(location.pathname + '?t=' + Date.now()), 250);
      } catch (e) {
        msg('写入失败，请重试');
      } finally {
        busy = false; seedBtn.disabled = false;
      }
    };
  }

  // 健康提示条渲染
  const hEl = document.getElementById('health-tip');
  function renderHealth(d){
    const ok = d.ok !== false;
    const cnt = d.db && typeof d.db.receipts_count !== 'undefined' ? d.db.receipts_count : '–';
    const sqlite = d.db && d.db.sqlite_exists ? '✅ DB 就绪' : '⚠️ DB';
    const tsa = d.config && d.config.tsa_endpoint ? d.config.tsa_endpoint : '（未配置或基础版）';
    hEl.innerHTML = `状态：${ok ? '✅ 正常' : '❌ 异常'}｜${sqlite}｜条目：<b>${cnt}</b>｜TSA：<code>${tsa}</code>`;
    hEl.style.background = ok ? '#f0fff4' : '#fff5f5';
    hEl.style.borderColor = ok ? '#b7f7c2' : '#ffb3b3';
  }

  // 首次加载
const qs1 = new URLSearchParams({ cert_id: cert }).toString();
fetch(`/health?${qs1}`)
  .then(r => r.json())
  .then(renderHealth)
  .catch(() => {
    hEl.textContent = '获取健康信息失败（可能服务未运行或路径错误）';
    hEl.style.background = '#fff5f5';
    hEl.style.borderColor = '#ffb3b3';
  });

// 导出 CSV：把下拉转为精确语法，并与关键词一起拼成 q
const btnExport = document.getElementById('btn-export');
if (btnExport) btnExport.onclick = () => {
  const qEl   = document.getElementById('hist-q');
  const prov  = (document.getElementById('sel-provider')?.value || '').trim();
  const stat  = (document.getElementById('sel-status')?.value   || '').trim();

  const parts = [];
  if (prov) parts.push(`provider:${prov}`);
  if (stat) parts.push(`status:${stat}`);
  const free = qEl ? (qEl.value || '').trim() : '';
  if (free) parts.push(free);

  const qs = new URLSearchParams({ cert_id: cert });
  if (parts.length) qs.set('q', parts.join(' '));
  // 加时间戳避免浏览器缓存
  qs.set('t', Date.now().toString());

  window.open('/api/receipts/export?' + qs.toString(), '_blank');
};

  // 健康条自动刷新（5s）
setInterval(() => {
    const qs2 = new URLSearchParams({ cert_id: cert }).toString();
    fetch(`/health?${qs2}`)
       .then(r => r.json())
       .then(renderHealth)
      .catch(()=>{});
  }, 5000);
})();
</script>
</body>
</html>
