<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>证据升级校验 · {{ cert_id }}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="data:,">
  <style>
    body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei";margin:24px;color:#222;background:#fafafa}
    .card{max-width:880px;margin:auto;background:#fff;border:1px solid #eee;border-radius:12px;padding:20px 24px;box-shadow:0 4px 16px rgba(0,0,0,.04);margin-bottom:16px}
    h1{margin:0 0 8px;font-size:26px}
    h3{margin:0 0 8px;font-size:18px}
    .muted{color:#666}
    code{background:#f6f6f6;padding:2px 6px;border-radius:6px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;line-height:18px;border:1px solid transparent;vertical-align:middle}
    .badge-tsa{background:#e6f0ff;color:#1e40af;border-color:#bfdbfe}
    .badge-chain{background:#e8fff0;color:#166534;border-color:#bbf7d0}
    .status-success{color:#166534;font-weight:600}
    .status-failed{color:#991b1b;font-weight:600}
    .status-pending{color:#92400e;font-weight:600}
    .btn.btn-xs{ padding:2px 6px; font-size:12px; border-radius:6px; }
    .highlight-copy{ background:#fffbe6 !important; transition: background .6s ease; }
    #pv-body td:nth-child(4){ font-family:ui-monospace, Menlo, Consolas, monospace; }
    #pv-body td{ white-space:nowrap; vertical-align:middle; }
    #pv-body th { position: sticky; top: 0; background: #fff; z-index: 1; }
    #btn-export[disabled]{ cursor:not-allowed; }
    .btn{padding:6px 10px;border:1px solid #ddd;background:#f7f7f7;border-radius:6px;
     text-decoration:none;color:#111;cursor:pointer}
    /* 卡片小标题 + 说明行 */
    .card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:6px;
    }
    .card-sub{
      font-size:12px;
      color:#888;
    }

    /* 历史列表样式：去掉默认圆点，增加间距与分隔线 */
    .history-list{
      list-style:none;
      padding:0;
      margin:0;
    }
    .history-list li{
      padding:6px 0;
      border-bottom:1px dashed #eee;
      font-size:13px;
      line-height:1.5;
    }
    .history-list li:last-child{
      border-bottom:none;
    }
    .history-time{
      font-size:12px;
      color:#6b7280;
      margin-right:4px;
    }
   </style>
</head>
<body>
 
  <div class="card">
    <h1>Verify Upgrade</h1>
    <p class="muted">
      当前证书：<code>{{ cert_id }}</code>
      &nbsp;｜&nbsp;
      快速切换：
      <a href="/verify_upgrade/demo-cert">demo-cert</a>
      &nbsp;/&nbsp;
      <a href="/verify_upgrade/tom-001">tom-001</a>
      &nbsp;｜&nbsp;
      历史记录：
      <a href="/vault?cert_id={{ cert_id }}&sort=created_at&order=desc">打开 Vault</a>
    </p>
  </div>

  {# 计算最近一条回执，用于“最近回执”和写入 Vault 按钮 #}
  {% set last_provider = None %}
  {% set last_status = '' %}
  {% set last_txid = '' %}

  {% if history is defined and history and history|length > 0 %}
    {% set _last = history[0] %}
    {% if _last is mapping %}
      {% set last_provider = _last.get('provider') %}
      {% set last_status   = _last.get('status') %}
      {% set last_txid     = _last.get('txid') %}
    {% else %}
      {% set last_provider = _last.provider %}
      {% set last_status   = _last.status %}
      {% set last_txid     = _last.txid %}
    {% endif %}
  {% elif tsa_last_status is defined %}
    {# 如果没有 history，但还有 tsa_last_*，用它做后备 #}
    {% set last_status = tsa_last_status|default('', true) %}
    {% set last_txid   = tsa_last_txid|default('', true) %}
  {% endif %}

  {# 计算最近一条回执：优先用 history[0]，无论是 tsa 还是 chain #}
  {% set last_provider = None %}
  {% set last_status = '' %}
  {% set last_txid = '' %}

  {% if history is defined and history and history|length > 0 %}
    {% set _last = history[0] %}
    {% if _last is mapping %}
      {% set last_provider = _last.get('provider') %}
      {% set last_status   = _last.get('status') %}
      {% set last_txid     = _last.get('txid') %}
    {% else %}
      {% set last_provider = _last.provider %}
      {% set last_status   = _last.status %}
      {% set last_txid     = _last.txid %}
    {% endif %}
  {% elif tsa_last_status is defined %}
    {# 没有 history 时，用 tsa_last_* 作为后备 #}
    {% set last_status = tsa_last_status|default('', true) %}
    {% set last_txid   = tsa_last_txid|default('', true) %}
  {% endif %}

  <div class="card">
    <div class="card-header">
      <h3>最近回执</h3>
      {% if last_status %}
        <span class="card-sub">最新一次 TSA / Chain 结果</span>
      {% else %}
        <span class="card-sub">暂无数据</span>
      {% endif %}
    </div>

    {% if last_status %}
      <p>
        <span class="card-sub">来源：</span>
        {% if last_provider %}
          <span class="badge {{ 'badge-tsa' if last_provider=='tsa' else 'badge-chain' }}">{{ last_provider }}</span>
        {% else %}
          <span class="muted">未知</span>
        {% endif %}
      </p>

      <p>
        <span class="card-sub">状态：</span>
        {% set st = 'success' if last_status in ['ok','success']
         else 'failed' if last_status in ['error','failed']
         else 'pending' %}
        <span class="status-{{ st }}">{{ last_status }}</span>
      </p>

      <p>
        <span class="card-sub">TX：</span>
        {% if last_txid %}
          <code>{{ last_txid|e }}</code>
          <button class="btn btn-xs" data-copy-txid="{{ last_txid }}" aria-label="复制 txid">复制</button>
        {% else %}
          <span class="muted">无</span>
        {% endif %}
      </p>
    {% else %}
      <p class="muted">暂无回执。请先调用 TSA/Chain 回执接口。</p>
    {% endif %}
  </div>

  <div class="card">
    <div class="card-header">
      <h3>回执历史（近 5 条）</h3>
      <span class="card-sub">按时间倒序 · 方便一眼对比</span>
    </div>
    {% if history is defined and history and history|length>0 %}
      <ul class="history-list">
        {% for r in history %}
          {% set provider = r.provider if r is not mapping else r.get('provider') %}
          {% set status   = r.status   if r is not mapping else r.get('status') %}
          {% set txid     = r.txid     if r is not mapping else r.get('txid') %}
          {% set created  = r.created_at if r is not mapping else r.get('created_at') %}
          <li>
            <span class="history-time">
              {% if created %}{{ created }}{% else %}--{% endif %}
            </span>
            <span class="badge {{ 'badge-tsa' if provider=='tsa' else 'badge-chain' }}">{{ provider|default('unknown') }}</span>
            {% set map = {'ok':'success','success':'success','failed':'failed','error':'failed','pending':'pending'} %}
            · <span class="status-{{ map.get((status or '')|lower, 'pending') }}">{{ status|default('pending') }}</span>
            {% if txid %}
              · TX:
              <code>{{ txid|e }}</code>
              <button class="btn btn-xs" data-copy-txid="{{ txid }}" aria-label="复制 txid">复制</button>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="muted">暂无历史记录。</p>
    {% endif %}
  </div>
  <div class="card">
    <h3>证据信息（业务字段预留）</h3>
    {% set ev = evidence if evidence is defined else {} %}

    <!-- 输入区：业务编号 + 标题 + Owner -->
    <div style="margin-bottom:8px;font-size:13px;">填写 / 修改业务信息（目前仅前端展示）：</div>
    <div style="display:flex;flex-direction:column;gap:6px;max-width:420px;margin-bottom:10px;">
      <label style="font-size:13px;display:flex;flex-direction:column;gap:2px;">
        <span>业务编号：</span>
        <input id="biz-case-id" name="case_id"
               value="{{ (ev.case_id if ev is not mapping else ev.get('case_id'))|default('', true) }}"
               placeholder="如：2025-11-23-A01"
               style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:6px;">
      </label>

      <label style="font-size:13px;display:flex;flex-direction:column;gap:2px;">
        <span>证据标题：</span>
        <input id="biz-title" name="title"
               value="{{ (ev.title if ev is not mapping else ev.get('title'))|default('', true) }}"
               placeholder="如：Demo Evidence / 学生作品说明"
               style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:6px;">
      </label>

      <label style="font-size:13px;display:flex;flex-direction:column;gap:2px;">
        <span>证据主体（Owner）：</span>
        <input id="biz-owner" name="owner"
               value="{{ (ev.owner if ev is not mapping else ev.get('owner'))|default('', true) }}"
               placeholder="如：Tom / Demo Student"
               style="width:100%;padding:4px 6px;border:1px solid #ddd;border-radius:6px;">
      </label>
    </div>
    <div style="margin-bottom:8px;">
      <button id="btn-save-biz" class="btn btn-xs" style="padding:4px 10px;border-radius:6px;">
        保存业务信息
      </button>
      <span id="biz-msg" class="muted" style="margin-left:8px;font-size:12px;"></span>
    </div>
 
    <!-- 当前值展示（从 evidence 里读） -->
    <ul>
      <li>
        <strong>业务编号（当前）：</strong>
        <code>
          {{ (ev.case_id if ev is not mapping else ev.get('case_id'))|default('--') }}
        </code>
      </li>
      <li>
        <strong>证据标题（当前）：</strong>
        <code>
          {{ (ev.title if ev is not mapping else ev.get('title'))|default('--') }}
        </code>
      </li>
      <li>
        <strong>证据主体（Owner，当前）：</strong>
        <code>
          {{ (ev.owner if ev is not mapping else ev.get('owner'))|default('--') }}
        </code>
      </li>
      <li>
        <strong>来源渠道：</strong>
        <code>
          {{ (ev.source if ev is not mapping else ev.get('source'))|default('--') }}
        </code>
      </li>
      <li>
        <strong>备注说明：</strong>
        <code>
          {{ (ev.notes if ev is not mapping else ev.get('notes'))|default('--') }}
        </code>
      </li>
    </ul>

    <hr style="border:none;border-top:1px dashed #eee;margin:10px 0;">

    <p class="muted" style="margin:4px 0 6px;">技术证明字段：</p>
    <ul>
      <li>
        <strong>文件路径：</strong>
        <code>
          {{ (ev.file_path if ev is not mapping else ev.get('file_path'))|default('--') }}
        </code>
      </li>
      <li>
        <strong>SHA-256：</strong>
        <code>
          {{ (ev.sha256 if ev is not mapping else ev.get('sha256'))|default('--') }}
        </code>
      </li>
      <li>
        <strong>C2PA Claim：</strong>
        <code>
          {{ (ev.c2pa_claim if ev is not mapping else ev.get('c2pa_claim'))|default('--') }}
        </code>
      </li>
      <li>
        <strong>TSA URL：</strong>
        <code>
          {{ (ev.tsa_url if ev is not mapping else ev.get('tsa_url'))|default('--') }}
        </code>
      </li>
      <li>
        <strong>链上 Tx（Sepolia）：</strong>
        <code>
          {{ (ev.sepolia_txhash if ev is not mapping else ev.get('sepolia_txhash'))|default('--') }}
        </code>
      </li>
    </ul>

    <p class="muted" style="margin-top:6px;">
    上面的输入框用于填写“业务编号 / 标题 / Owner”，点击「保存业务信息」后会写入本地数据库；
    下半部分为技术证明字段，仍然从 evidence 里读取，未提供时显示为 “--”。
    </p>
  </div>

<!-- 快捷操作 + 健康提示条 -->
<div id="quick-actions" style="margin:10px 0;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
  <button id="btn-refresh" style="padding:6px 10px;border:1px solid #d1d5db;background:#f9fafb;border-radius:8px;cursor:pointer">刷新历史</button>
  <button id="btn-clear"   style="padding:6px 10px;border:1px solid #d1d5db;background:#f9fafb;border-radius:8px;cursor:pointer">清空历史</button>
  <button id="btn-preview" style="padding:6px 10px;border:1px solid #d1d5db;background:#fff;border-radius:8px;cursor:pointer">预览</button>

  <!-- 新增：一键写入 Vault（使用最近回执） -->
  <button id="btn-write-vault" style="padding:6px 10px;border:1px solid #d1d5db;background:#e0f2fe;border-radius:8px;cursor:pointer">
    写入 Vault
  </button>

  <button id="btn-export"  style="padding:6px 10px;border:1px solid #d1d5db;background:#f0f9ff;border-radius:8px;cursor:pointer">导出 CSV</button>
  <a id="btn-vault" class="btn" href="/vault?cert_id={{ cert_id }}" title="回溯列表（Vault）">
   Vault (<span id="vault-count">--</span>)
</a>
  <span id="export-hint"  style="font-size:12px;color:#6b7280;">（预计：-- 条）</span>

  <!-- 在这行后面插入“清空所有”按钮 -->
  <button id="btn-clear-all"
          style="display:none;padding:6px 10px;border:1px solid #ef4444;background:#fff5f5;border-radius:8px;cursor:pointer;color:#b91c1c"
          title="仅本机显示：清空所有证书（内存+DB）">清空所有（All）</button>

  <!-- 下面是原有的输入/下拉/导出按钮 -->
  <input id="hist-q" placeholder="关键词（可含 tx 片段）" style="padding:6px 8px;border:1px solid #d1d5db;border-radius:8px;min-width:180px" />
  <label style="font-size:12px;color:#666">Provider</label>
  <select id="sel-provider" style="padding:6px 8px;border:1px solid #d1d5db;border-radius:8px">
    <option value="">All</option><option value="tsa">tsa</option><option value="chain">chain</option>
  </select>
  <label style="font-size:12px;color:#666">Status</label>
  <select id="sel-status" style="padding:6px 8px;border:1px solid #d1d5db;border-radius:8px">
    <option value="">All</option><option value="ok">ok</option><option value="pending">pending</option><option value="failed">failed</option>
  </select>
<button id="btn-seed" class="btn">写入示例数据</button>
<span id="quick-msg" style="color:#6b7280;font-size:12px;margin-left:6px"></span>
</div>

<div id="health-tip" style="margin-top:10px;padding:8px 12px;border:1px solid #eee;border-radius:8px;font-size:13px;background:#fafafa">正在读取健康信息…</div>

<script>
(()=> {
  'use strict';
function fmtTime(t){ return (t||'').replace('T',' ').replace('Z',''); }

  const cert = "{{ cert_id|default('') }}";
  const msg  = s => { const el = document.getElementById('quick-msg'); if (el) el.textContent = s || ''; };

  // 最近回执的信息（来自上面模板里的 last_provider / last_status / last_txid）
  const LAST_PROVIDER = {{ last_provider|default('')|tojson }};
  const LAST_STATUS   = {{ last_status|default('')|tojson }};
  const LAST_TXID     = {{ last_txid|default('')|tojson }};

  // ===== 工具函数区 =====
  function escHtml(s){
    return String(s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function flashNode(el){
    if(!el) return;
    el.classList.add('highlight-copy');
    setTimeout(()=> el.classList.remove('highlight-copy'), 700);
  }

  function debounce(fn, ms = 200){
    let t;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), ms);
    };
  }  // ← 结束 debounce
function csvCell(v){
  const s = String(v ?? '');
  // 用双引号包裹，内部的引号转义为两个引号，换行替成空格
  return `"${s.replace(/"/g, '""').replace(/\r?\n/g, ' ')}"`;
}

  let __countReqId = 0;  // 计数请求序号（用于丢弃过期响应）
  // ===== 工具函数区结束 =====

  // —— 筛选项本地记忆（按 cert 作用域）——
  const _memKey = (name) => `vu:${cert}:filter:${name}`;

  function loadFilters() {
    try {
      const q = localStorage.getItem(_memKey('q')) ?? '';
      const provider = localStorage.getItem(_memKey('provider')) ?? '';
      const status   = localStorage.getItem(_memKey('status')) ?? '';
      const qEl   = document.getElementById('hist-q');
      const pEl   = document.getElementById('sel-provider');
      const sEl   = document.getElementById('sel-status');
      if (qEl) qEl.value = q;
      if (pEl) pEl.value = provider;
      if (sEl) sEl.value = status;
    } catch (e) {}
  }

  function saveFilters() {
    try {
      const qEl   = document.getElementById('hist-q');
      const pEl   = document.getElementById('sel-provider');
      const sEl   = document.getElementById('sel-status');
      if (qEl) localStorage.setItem(_memKey('q'), qEl.value || '');
      if (pEl) localStorage.setItem(_memKey('provider'), (pEl.value || ''));
      if (sEl) localStorage.setItem(_memKey('status'),   (sEl.value || ''));
    } catch (e) {}
  }

  // 刷新按钮
  const btnRefresh = document.getElementById('btn-refresh');
  if (btnRefresh) btnRefresh.onclick = () =>
    location.replace(location.pathname + '?t=' + Date.now());

  // 清空（单证书）
  const btnClear = document.getElementById('btn-clear');
  if (btnClear) btnClear.onclick = () => {
    fetch(`/api/receipts/clear?cert_id=${encodeURIComponent(cert)}`, { method: 'POST' })
      .then(r => r.json())
      .then(async d => {
        msg(`已清空 ${d.cleared || 0} 条`);
        const h = await fetch('/health?' + new URLSearchParams({ cert_id: cert })).then(r => r.json());
        renderHealth(h);
        updateExportHint();
        setTimeout(() => location.replace(location.pathname + '?t=' + Date.now()), 200);
      })
      .catch(() => msg('清空失败，请重试'));
  };

  // 一键写入示例数据
  const seedBtn = document.getElementById('btn-seed');
  if (seedBtn) {
    let busy = false;
    seedBtn.onclick = async () => {
      if (busy) return; busy = true; seedBtn.disabled = true;
      try {
        await Promise.all([
          fetch(`/api/tsa/mock?cert_id=${encodeURIComponent(cert)}`),
          fetch(`/api/chain/mock?cert_id=${encodeURIComponent(cert)}`)
        ]);
        msg('已写入示例数据 2 条');
        updateExportHint();
        setTimeout(() => location.replace(location.pathname + '?t=' + Date.now()), 250);
      } catch (e) {
        msg('写入失败，请重试');
      } finally {
        busy = false; seedBtn.disabled = false;
      }
    };
  }
  // 写入 Vault（使用最近回执）
  const btnWriteVault = document.getElementById('btn-write-vault');
  if (btnWriteVault) {
    btnWriteVault.onclick = async () => {
      // 没有最近回执就不给写
      if (!LAST_TXID || !LAST_STATUS || !LAST_PROVIDER) {
        msg('当前没有可写入的回执');
        return;
      }

      btnWriteVault.disabled = true;
      msg('正在写入 Vault…');

      try {
        const body = {
          provider: LAST_PROVIDER,
          status:   LAST_STATUS,
          tx:       LAST_TXID
        };

        const res = await fetch(`/api/receipts/add?cert_id=${encodeURIComponent(cert)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();

        if (!data || data.ok === false) {
          msg('写入 Vault 失败');
        } else {
          msg('已写入 Vault 1 条');

          // 更新底部 Vault(N) 的数量
          try {
            const d = await fetch('/api/receipts/count?' + new URLSearchParams({ cert_id: String(cert) })).then(r => r.json());
            const el = document.getElementById('vault-count');
            if (el && d && d.ok && typeof d.count === 'number') el.textContent = d.count;
          } catch (e) {}
        }
      } catch (e) {
        msg('写入 Vault 失败，请重试');
      } finally {
        btnWriteVault.disabled = false;
      }
    };
  }

  // 清空所有（仅本机显示 + 二次确认）
  const btnClearAll = document.getElementById('btn-clear-all');
  if (btnClearAll) {
    const isLocal = (location.hostname === '127.0.0.1' || location.hostname === 'localhost');
    if (isLocal) btnClearAll.style.display = 'inline-block';
  // 保存业务信息（case_id / title / owner）
  const btnSaveBiz = document.getElementById('btn-save-biz');
  if (btnSaveBiz) {
    btnSaveBiz.onclick = async () => {
      const caseId = document.getElementById('biz-case-id')?.value || '';
      const title  = document.getElementById('biz-title')?.value || '';
      const owner  = document.getElementById('biz-owner')?.value || '';
      const infoEl = document.getElementById('biz-msg');

      if (infoEl) infoEl.textContent = '保存中…';
      btnSaveBiz.disabled = true;

      try {
        const payload = {
          cert_id: cert,
          case_id: caseId,
          title:   title,
          owner:   owner
        };
        const res  = await fetch('/api/evidence/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data && data.ok === false) {
          throw new Error(data.error || '保存失败');
        }

        if (infoEl) infoEl.textContent = '已保存（刷新后可看到“当前”字段更新）';
      } catch (e) {
        if (infoEl) infoEl.textContent = '保存失败：' + (e && e.message ? e.message : '请稍后重试');
      } finally {
        btnSaveBiz.disabled = false;
      }
    };
  }


    btnClearAll.onclick = async () => {
      if (!isLocal) return;
      if (!confirm('⚠️ 将清空【所有证书】的历史记录（内存 + DB）。确定继续？')) return;
      const text = prompt('第二步确认：请输入 DELETE');
      if ((text || '').trim().toUpperCase() !== 'DELETE') { msg('已取消'); return; }

      try {
        btnClearAll.disabled = true;
        const res = await fetch('/api/receipts/clear', { method: 'POST' }); // 不带 cert_id => 全清
        const d = await res.json();
        msg(`已清空所有：${d.cleared || 0} 条`);
        const h = await fetch('/health?' + new URLSearchParams({ cert_id: cert })).then(r=>r.json());
        renderHealth(h);
        updateExportHint();
        setTimeout(() => location.replace(location.pathname + '?t=' + Date.now()), 300);
      } catch (e) {
        msg('清空失败，请重试');
      } finally {
        btnClearAll.disabled = false;
      }
    };
  }

  // 健康提示条
  const hEl = document.getElementById('health-tip');
  function renderHealth(d){
    const ok = d.ok !== false;
    const cnt = d.db && typeof d.db.receipts_count !== 'undefined' ? d.db.receipts_count : '–';
    const sqlite = d.db && d.db.sqlite_exists ? '✅ DB 就绪' : '⚠️ DB';
    const tsa = d.config && d.config.tsa_endpoint ? d.config.tsa_endpoint : '（未配置或基础版）';
    hEl.innerHTML = `状态：${ok ? '✅ 正常' : '❌ 异常'}｜${sqlite}｜条目：<b>${cnt}</b>｜TSA：<code>${tsa}</code>`;
    hEl.style.background = ok ? '#f0fff4' : '#fff5f5';
    hEl.style.borderColor = ok ? '#b7f7c2' : '#ffb3b3';
  }

// 保留这两行：先渲染一次
const qs1 = new URLSearchParams({ cert_id: cert }).toString();
fetch(`/health?${qs1}`).then(r => r.json()).then(renderHealth).catch(()=>{});

// 替换掉旧的 setInterval(...) 为下面的“降频+可见性控制”
let __healthTimer = null;
async function __ping(){ try{ await fetch(`/health?${qs1}`); }catch(e){} }
function __start(){ if(!__healthTimer) __healthTimer = setInterval(__ping, 4000); }
function __stop(){ if(__healthTimer){ clearInterval(__healthTimer); __healthTimer = null; } }
document.addEventListener('visibilitychange', ()=> document.hidden ? __stop() : __start());
window.addEventListener('load', __start);
window.addEventListener('beforeunload', __stop);

  // 导出 CSV
  const btnExport = document.getElementById('btn-export');
  if (btnExport) btnExport.onclick = () => {
    updateExportHint(); // 点击导出前先刷新提示
    const qEl   = document.getElementById('hist-q');
    const prov  = (document.getElementById('sel-provider')?.value || '').trim();
    const stat  = (document.getElementById('sel-status')?.value   || '').trim();

    const parts = [];
    if (prov) parts.push(`provider:${prov}`);
    if (stat) parts.push(`status:${stat}`);
    const free = qEl ? (qEl.value || '').trim() : '';
    if (free) parts.push(free);

    const qs = new URLSearchParams({ cert_id: cert });
    if (parts.length) qs.set('q', parts.join(' '));
    qs.set('t', Date.now().toString());
    window.open('/api/receipts/export?' + qs.toString(), '_blank');
  };

  // 构建查询
  function buildQueryParts(){
    const qEl = document.getElementById('hist-q');
    const prov = (document.getElementById('sel-provider')?.value || '').trim();
    const stat = (document.getElementById('sel-status')?.value || '').trim();
    const parts = [];
    if (prov) parts.push(`provider:${prov}`);
    if (stat) parts.push(`status:${stat}`);
    const free = qEl ? (qEl.value || '').trim() : '';
    if (free) parts.push(free);
    return parts;
  }

  // 精确计数（防抖 + 防并发）
  async function updateExportHint(){
    const hintEl = document.getElementById('export-hint');
    if (!hintEl) return;
    try {
      const reqId = ++__countReqId;
      const parts = buildQueryParts();
      const qs = new URLSearchParams({ cert_id: String(cert), t: Date.now().toString() });
      if (parts.length) qs.set('q', parts.join(' '));
      const d = await fetch('/api/receipts/count?' + qs).then(r => r.json());
      if (reqId !== __countReqId) return;  // 丢弃过期结果
      const n = (d && d.ok && typeof d.count === 'number') ? d.count : 0;
      hintEl.textContent = `（预计：${n} 条）`;
      const btn = document.getElementById('btn-export');
      if (btn){ btn.disabled = n <= 0; btn.style.opacity = n > 0 ? 1 : 0.5; }
    } catch (e) {
      const hintEl2 = document.getElementById('export-hint');
      if (hintEl2) hintEl2.textContent = '（预计：--）';
    }
  }

  // 监听筛选（200ms 防抖）
  const onFilterChange = debounce(() => { saveFilters(); updateExportHint(); }, 200);
  ['hist-q','sel-provider','sel-status'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('input',  onFilterChange);
    el.addEventListener('change', onFilterChange);
  });

loadFilters();
updateExportHint();
// 页面重新可见或窗口获得焦点时，自动刷新“预计：N 条”
document.addEventListener('visibilitychange', () => { if (!document.hidden) updateExportHint(); });
window.addEventListener('focus', updateExportHint);

fetch('/api/receipts/count?' + new URLSearchParams({ cert_id: String(cert) }))
  .then(r => r.json())
  .then(d => {
    const el = document.getElementById('vault-count');
    if (el && d && d.ok && typeof d.count === 'number') el.textContent = d.count;
  })
  .catch(() => {});

// （再往下是 showPreviewDialog 等）
// 页面重新可见或窗口获得焦点时，自动刷新“预计条数”

  // 预览弹窗
function showPreviewDialog(data){
  // 唯一的 overlay、card
  const overlay = document.createElement('div');
  overlay.id = 'vu-preview-overlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:9999;';
  const card = document.createElement('div');
  card.style.cssText = 'background:#fff;border-radius:12px;max-width:900px;width:90vw;max-height:80vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.2);';

  // 头部 + 全部CSV/JSON + 关闭
  card.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #eee;">
      <div style="font-weight:600">预览（前 ${data.limit} 条 / 共 ${data.total}）</div>
      <div>
        <button class="btn btn-xs" data-copy-all="csv"  title="复制本次预览的全部行为 CSV"  style="margin-right:6px;">全部CSV</button>
        <button class="btn btn-xs" data-copy-all="json" title="复制本次预览的全部行为 JSON" style="margin-right:10px;">全部JSON</button>
        <button id="pv-close" style="padding:4px 8px;border:1px solid #ddd;background:#f8f8f8;border-radius:8px;cursor:pointer">关闭</button>
      </div>
    </div>
    <div style="padding:12px 16px;">
      <table style="width:100%;border-collapse:collapse;font-size:13px">
        <thead>
          <tr>
            <th style="text-align:left;border-bottom:1px solid #eee;padding:6px 8px;">cert_id</th>
            <th style="text-align:left;border-bottom:1px solid #eee;padding:6px 8px;">provider</th>
            <th style="text-align:left;border-bottom:1px solid #eee;padding:6px 8px;">status</th>
            <th style="text-align:left;border-bottom:1px solid #eee;padding:6px 8px;">txid</th>
            <th style="text-align:left;border-bottom:1px solid #eee;padding:6px 8px;">created_at</th>
          </tr>
        </thead>
        <tbody id="pv-body"></tbody>
      </table>
    </div>
  `;
  overlay.appendChild(card);
  document.body.appendChild(overlay);

  // 渲染行（埋 dataset + 行内 CSV/JSON 按钮）
  const tbody = card.querySelector('#pv-body');
  (data.rows || []).forEach(r => {
    const tr = document.createElement('tr');

    tr.dataset.certId    = r.cert_id    || '';
    tr.dataset.provider  = r.provider   || '';
    tr.dataset.status    = r.status     || '';
    tr.dataset.txid      = r.txid       || '';
    tr.dataset.createdAt = r.created_at || '';

    ['cert_id','provider','status','txid','created_at'].forEach(k=>{
      const td = document.createElement('td');
      td.style.cssText = 'border-bottom:1px solid #f3f3f3;padding:6px 8px;white-space:nowrap;';
      if (k === 'txid') {
        const tx = r[k] || '';
        const txEsc = escHtml(tx);
        const base = tx ? `${txEsc} <button class="btn btn-xs" data-copy-txid="${tx}" title="复制 txid" aria-label="复制 txid">复制</button>` : '';
        const extra = ` <button class="btn btn-xs" data-copy-row="csv" title="复制此行为 CSV">CSV</button>
                        <button class="btn btn-xs" data-copy-row="json" title="复制此行为 JSON">JSON</button>`;
        td.innerHTML = tx ? (base + extra) : extra;
      } else {
      td.textContent = (k === 'created_at') ? fmtTime(r[k] || '') : (r[k] || '');
      }
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  const close = () => overlay.remove();
  card.querySelector('#pv-close').onclick = close;
  overlay.onclick = (e) => { if (e.target === overlay) close(); };
}

  // 预览按钮
  const btnPreview = document.getElementById('btn-preview');
  if (btnPreview) btnPreview.onclick = async () => {
    try{
      const parts = buildQueryParts();
      const qs = new URLSearchParams({ cert_id: String(cert), limit: '20', t: Date.now().toString() });
      if (parts.length) qs.set('q', parts.join(' '));
      const data = await fetch('/api/receipts/preview?' + qs).then(r=>r.json());
      if (!data || data.ok === false) { msg('预览失败'); return; }
      showPreviewDialog(data);
    } catch (e) { msg('预览失败'); }
  };

  // 复制文本 + 高亮
  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      if (typeof toast === 'function') { toast(`已复制：${text.slice(0,8)}...`); }
      else { msg(`已复制：${text.slice(0,8)}...`); }
    }catch(e){
      const ta=document.createElement('textarea');
      ta.value=text; document.body.appendChild(ta);
      ta.select(); document.execCommand('copy');
      document.body.removeChild(ta);
      msg(`已复制：${text.slice(0,8)}...`);
    }
  }

document.addEventListener('click', (ev)=>{
  // 1) 复制单个 txid
  const btnTx = ev.target.closest('[data-copy-txid]');
  if (btnTx) {
    const tx = btnTx.getAttribute('data-copy-txid') || '';
    if (tx) copyText(tx);

    // 按钮文案短反馈（防连点）
    if (!btnTx.dataset.copied) {
      const oldText = btnTx.textContent;
      btnTx.dataset.copied = '1';
      btnTx.textContent = '已复制';
      btnTx.disabled = true;
      setTimeout(()=>{
        btnTx.textContent = oldText;
        btnTx.disabled = false;
        delete btnTx.dataset.copied;
      }, 500);
    }

    const row = btnTx.closest('tr') || btnTx.closest('li') || btnTx.parentElement;
    flashNode(row);
    return; // 避免同时触发下面的 copy-row 分支
  }

  // 2) 复制整行（CSV/JSON）
  const btnRow = ev.target.closest('[data-copy-row]');
  if (btnRow) {
    const tr = btnRow.closest('tr');
    if (!tr) return;

    const rowData = {
      cert_id:    tr.dataset.certId    || '',
      provider:   tr.dataset.provider  || '',
      status:     tr.dataset.status    || '',
      txid:       tr.dataset.txid      || '',
      created_at: tr.dataset.createdAt || ''
    };

    const mode = btnRow.getAttribute('data-copy-row'); // 'csv' | 'json'
    if (mode === 'json') {
      copyText(JSON.stringify(rowData, null, 2));
    } else {
      const line = [rowData.cert_id, rowData.provider, rowData.status, rowData.txid, rowData.created_at]
        .map(csvCell).join(',');
      copyText(line);
    }

    const old = btnRow.textContent;
    btnRow.textContent = '已复制';
    btnRow.disabled = true;
    setTimeout(()=>{ btnRow.textContent = old; btnRow.disabled = false; }, 600);

    flashNode(tr);
  }
});
document.addEventListener('click', (ev)=>{
  const btnAll = ev.target.closest('[data-copy-all]');   // 匹配“全部CSV/全部JSON”
  if (!btnAll) return;

  // 取当前预览弹窗（我们在 showPreviewDialog 里给 overlay 设置了 id="vu-preview-overlay"）
  const root = document.getElementById('vu-preview-overlay') || btnAll.closest('#vu-preview-overlay');
  if (!root) return;

  // 收集所有行的 dataset
  const rows = Array.from(root.querySelectorAll('#pv-body tr'));
  const items = rows.map(tr => ({
    cert_id:    tr.dataset.certId    || '',
    provider:   tr.dataset.provider  || '',
    status:     tr.dataset.status    || '',
    txid:       tr.dataset.txid      || '',
    created_at: tr.dataset.createdAt || ''
  }));

  const mode = btnAll.getAttribute('data-copy-all');  // 'csv' | 'json'
  if (mode === 'json') {
    copyText(JSON.stringify(items, null, 2));
  } else {
    const header = ['cert_id','provider','status','txid','created_at'].map(csvCell).join(',');
    const lines  = items.map(o => [o.cert_id,o.provider,o.status,o.txid,o.created_at].map(csvCell).join(','));
    copyText([header, ...lines].join('\n'));
  }

  // 按钮小反馈
  const old = btnAll.textContent;
  btnAll.textContent = '已复制';
  btnAll.disabled = true;
  setTimeout(()=>{ btnAll.textContent = old; btnAll.disabled = false; }, 700);
});
 // 这里继续保留 IIFE 的结束
})();   // ← 不要删
</script>
</body>
</html>
